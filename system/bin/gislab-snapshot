#!/bin/bash

set -e

source /etc/gislab_version
source $GISLAB_ROOT/functions.sh

# require root privileges
gislab_require_root


# usage
function usage() {
	echo "USAGE: $(basename $0) [OPTIONS] [ -l ] [ -c <comment> ] [ -d ] [ -r ]"
	echo "Backup or restore GIS.lab server system (root filesystem)."
	echo -e "\nOPTIONS
	-h  display this help
	-l  print a list of backups
	-c  backup system (comment is required, allowed characters [a-zA-Z0-9_-], max 12 chars.)
	-d  delete backup
	-r  restore from backup
	"
	exit 255
}


# options
while getopts "lcd:r:h" OPTION
do
        case "$OPTION" in
			l) ACTION="list" ;;
			c) ACTION="create"
			   COMMENT="$2" ;;
			d) ACTION="delete"
			   SNAP="$2" ;;
			r) ACTION="restore"
			   SNAP="$2" ;;
			h) usage ;;
			\?) exit 1;;
        esac
done

if [ $# -eq 0 ]; then usage; fi

# check if root filesystem is on LVM
if [ -z "$(lvs --version 2>/dev/null)" -a -z "$(mount | grep '^/dev/mapper/vgmain-root on / ')" ]; then
    gislab_print_error "Root filesystem is not using LVM."
fi

bkp_dir=/storage/backup/boot
mkdir -p $bkp_dir

case "$ACTION" in
	list)
		echo
		lvs --noheadings -o lv_name vgmain | grep -E '^[[:space:]]+root_[_0-9]{17}\+.*$' \
		  || gislab_print_info "None backups found"
		echo
		;;
	create)
		if [ -z "$COMMENT" ]; then
			usage
		fi

		# check comment characters
		if ! echo "$COMMENT" | grep -qE '^[a-zA-Z0-9_-]{1,12}$'; then
			gislab_print_error "Not allowed characters in comment or length exceed 12 characters"
		fi

		postfix="$COMMENT"
		date="$(date '+%Y%m%d_%H_%M_%S')"
		sname="root_$date+$postfix"
		lvcreate -n $sname -L 1G -s /dev/vgmain/root
		mkdir $bkp_dir/$date
		cp -a /boot/* $bkp_dir/$date/
		gislab_print_info "Backup '$sname' successfuly created"
		;;
	delete)
		if [ ! -h /dev/vgmain/$SNAP ]; then
			gislab_print_error "Snapshot '$SNAP' does not exists"
		fi

		boot_dir="${SNAP:5:17}"
		rm -rf $bkp_dir/$boot_dir
		lvremove -f /dev/vgmain/$SNAP
		;;
	restore)
		if [ ! -h /dev/vgmain/$SNAP ]; then
			gislab_print_error "Snapshot '$SNAP' does not exists"
		fi

		lvconvert --merge /dev/vgmain/$SNAP
		boot_bkp_dir="${SNAP:5:17}"
		rm -rf /boot/*
		cp -a $bkp_dir/$boot_bkp_dir/* /boot/
		rm -rf $bkp_dir/$boot_bkp_dir
		gislab_print_warning "Reboot GIS.lab server now to apply changes"
		;;
esac


# vim: set ts=4 sts=4 sw=4 noet:
